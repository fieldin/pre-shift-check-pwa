<!--
  Pending Component Template
  
  Displays pending (unsynced) events and faults with actions.
  Allows editing, retrying, and deleting pending items.
-->

<div class="pending-page">
  <!-- Header -->
  <header class="header">
    <button class="back-btn" routerLink="/">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
    </button>
    <h1>Pending Uploads</h1>
  </header>

  <!-- Sync Status Bar -->
  <div class="sync-bar">
    <div class="sync-status">
      <span class="status-dot" [class.online]="syncService.isOnline()"></span>
      <span>{{ syncService.isOnline() ? 'Online' : 'Offline' }}</span>
    </div>
    <button
      class="btn btn-primary btn-small"
      (click)="syncNow()"
      [disabled]="!syncService.isOnline() || syncService.isSyncing()"
    >
      {{ syncService.isSyncing() ? 'Syncing...' : 'Sync All' }}
    </button>
  </div>

  <main class="main-content">
    <!-- Pending Events Section -->
    <section class="section">
      <h2 class="section-title">Pending Checks ({{ pendingEvents().length }})</h2>

      @if (pendingEvents().length === 0) {
        <div class="empty-card">
          <span class="empty-icon">✓</span>
          <span class="empty-text">All checks synced</span>
        </div>
      } @else {
        <div class="items-list">
          @for (event of pendingEvents(); track event.event_id) {
            <div class="item-card">
              <!-- Main row with result, info, and status -->
              <div class="item-main">
                <div class="item-result" [ngClass]="utils.getResultClass(event.result)">
                  {{ event.result === 'PASS' ? '✓' : '✗' }}
                </div>
                <div class="item-info">
                  <span class="item-title">{{ event.asset_id }}</span>
                  <span class="item-subtitle">
                    {{ event.machine_class }} · {{ utils.formatDateTime(event.completed_at) }}
                  </span>
                </div>
                <span class="badge" [ngClass]="utils.getSyncStatusBadgeClass(event.sync_status)">
                  {{ event.sync_status }}
                </span>
              </div>

              <!-- Error message if sync failed -->
              @if (event.last_error) {
                <div class="item-error">
                  <span>⚠️</span> {{ event.last_error }}
                </div>
              }

              <!-- Action buttons -->
              <div class="item-actions">
                @if (event.sync_status !== 'SYNCED') {
                  <button class="btn btn-secondary btn-small" (click)="editEvent(event)">
                    Edit
                  </button>
                }
                @if (event.sync_status === 'ERROR') {
                  <button class="btn btn-outline btn-small" (click)="retryEvent(event)">
                    Retry
                  </button>
                }
                @if (event.sync_status !== 'SYNCED') {
                  <button class="btn btn-danger btn-small" (click)="deleteEvent(event)">
                    Delete
                  </button>
                }
              </div>
            </div>
          }
        </div>
      }
    </section>

    <!-- Pending Faults Section -->
    <section class="section">
      <h2 class="section-title">Pending Faults ({{ pendingFaults().length }})</h2>

      @if (pendingFaults().length === 0) {
        <div class="empty-card">
          <span class="empty-icon">✓</span>
          <span class="empty-text">All faults synced</span>
        </div>
      } @else {
        <div class="items-list">
          @for (fault of pendingFaults(); track fault.fault_id) {
            <div class="item-card">
              <!-- Main row with priority, info, and status -->
              <div class="item-main">
                <div class="item-priority" [class]="fault.priority.toLowerCase()">!</div>
                <div class="item-info">
                  <span class="item-title">{{ fault.asset_id }}</span>
                  <span class="item-subtitle">{{ utils.truncate(fault.description, 40) }}</span>
                </div>
                <span class="badge" [ngClass]="utils.getSyncStatusBadgeClass(fault.sync_status)">
                  {{ fault.sync_status }}
                </span>
              </div>

              <!-- Error message if sync failed -->
              @if (fault.last_error) {
                <div class="item-error">
                  <span>⚠️</span> {{ fault.last_error }}
                </div>
              }

              <!-- Retry action for errors -->
              @if (fault.sync_status === 'ERROR') {
                <div class="item-actions">
                  <button class="btn btn-outline btn-small" (click)="retryFault(fault)">
                    Retry
                  </button>
                </div>
              }
            </div>
          }
        </div>
      }
    </section>
  </main>
</div>

